# MQTTæ•°æ®æ¥æ”¶åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ¦‚è¿°

æœ¬æŠ¥å‘Šè¯¦ç»†è®°å½•äº†æ— äººèˆ¹ä½œä¸šå®‰å…¨é¢„æµ‹ç³»ç»ŸMQTTæ•°æ®æ¥æ”¶åŠŸèƒ½çš„æµ‹è¯•è¿‡ç¨‹å’Œç»“æœã€‚

**æµ‹è¯•æ—¶é—´**: 2024å¹´8æœˆ16æ—¥  
**æµ‹è¯•ç‰ˆæœ¬**: v2.0.0  
**æµ‹è¯•ç¯å¢ƒ**: Ubuntu Linux + mosquitto 2.0.11  

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯ç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®æ¥æ”¶å’Œè§£æå¤–ç•Œé€šè¿‡MQTTå‘é€çš„å„ç§ç±»å‹æ•°æ®ï¼š
- èˆ¹åªçŠ¶æ€æ•°æ®
- ç¢°æ’å‘Šè­¦æ•°æ®
- ç³»ç»Ÿé…ç½®æ•°æ®
- èˆ°é˜Ÿå‘½ä»¤æ•°æ®
- å¿ƒè·³æ¶ˆæ¯
- èˆ¹åä¿¡æ¯
- èˆªçº¿ä¿¡æ¯

## ğŸ”§ é—®é¢˜å‘ç°ä¸ä¿®å¤

### é—®é¢˜1: JSONæ•°æ®è§£æå¤±è´¥

**ç°è±¡**: æ¥æ”¶åˆ°çš„æ•°æ®æ˜¾ç¤ºä¸ºé»˜è®¤å€¼ï¼ˆå…¨ä¸º0æˆ–ç©ºï¼‰
```
âš™ï¸ æ¥æ”¶åˆ°ç³»ç»Ÿé…ç½®æ›´æ–°:
  èˆ¹åªå°ºå¯¸: 0.0m Ã— 0.0m
  ç´§æ€¥é˜ˆå€¼: 0.0 ç§’
  è­¦å‘Šé˜ˆå€¼: 0.0 ç§’
```

**åŸå› åˆ†æ**: 
- MQTTé€šä¿¡å™¨ä¸­è°ƒç”¨äº†ä¸å­˜åœ¨çš„å®ä¾‹æ–¹æ³•`boat.fromJson(json)`
- å®é™…åªæœ‰é™æ€æ–¹æ³•`BoatState::fromJson(json)`
- å¯¼è‡´JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼

**è§£å†³æ–¹æ¡ˆ**:
1. ä¸º`BoatState`å’Œ`SystemConfig`æ·»åŠ å®ä¾‹ç‰ˆæœ¬çš„JSONè§£ææ–¹æ³•
2. æ–¹æ³•å‘½åä¸º`loadFromJson()`é¿å…ä¸é™æ€æ–¹æ³•å†²çª
3. æ›´æ–°MQTTé€šä¿¡å™¨ä¸­çš„è°ƒç”¨

**ä¿®å¤ä»£ç **:
```cpp
// types.h
struct BoatState {
    // ...
    void loadFromJson(const Json::Value& json);  // æ–°å¢å®ä¾‹æ–¹æ³•
};

// types.cpp
void BoatState::loadFromJson(const Json::Value& json) {
    sysid = json["sysid"].asInt();
    timestamp = json["timestamp"].asDouble();
    lat = json["lat"].asDouble();
    lng = json["lng"].asDouble();
    heading = json["heading"].asDouble();
    speed = json["speed"].asDouble();
    status = static_cast<BoatStatus>(json["status"].asInt());
    route_direction = static_cast<RouteDirection>(json["route_direction"].asInt());
}

// mqtt_communicator.cpp
bool MQTTCommunicator::parseBoatState(const std::string& payload, BoatState& boat) {
    // ...
    if (Json::parseFromStream(builder, stream, &json, &errors)) {
        boat.loadFromJson(json);  // ä½¿ç”¨å®ä¾‹æ–¹æ³•
        return true;
    }
    // ...
}
```

## âœ… æµ‹è¯•ç»“æœ

### æµ‹è¯•1: èˆ¹åªçŠ¶æ€æ•°æ®æ¥æ”¶

**å‘é€æ•°æ®**:
```json
{
  "sysid": 1,
  "timestamp": 1722325600.0,
  "lat": 30.549832,
  "lng": 114.342922,
  "heading": 90.0,
  "speed": 2.5,
  "status": 2,
  "route_direction": 1
}
```

**æ¥æ”¶ç»“æœ**:
```
ğŸš¢ æ¥æ”¶åˆ°èˆ¹åªçŠ¶æ€æ•°æ®:
  èˆ¹åªID: 1
  æ—¶é—´æˆ³: 1722325600.000
  ä½ç½®: (30.549832, 114.342922)
  èˆªå‘: 90.0Â°
  é€Ÿåº¦: 2.5 m/s
  çŠ¶æ€: æ­£å¸¸èˆªè¡Œ
  èˆªçº¿æ–¹å‘: é¡ºæ—¶é’ˆ
âœ… èˆ¹åªçŠ¶æ€å·²æ›´æ–°åˆ°ç³»ç»Ÿ
```

**ç»“æœ**: âœ… **é€šè¿‡** - æ•°æ®å®Œå…¨æ­£ç¡®è§£æ

### æµ‹è¯•2: ç³»ç»Ÿé…ç½®æ•°æ®æ¥æ”¶

**å‘é€æ•°æ®**:
```json
{
  "boat": {
    "length": 0.75,
    "width": 0.47
  },
  "emergency_threshold_s": 5,
  "warning_threshold_s": 30,
  "max_boats": 30,
  "min_route_gap_m": 10
}
```

**æ¥æ”¶ç»“æœ**:
```
âš™ï¸ æ¥æ”¶åˆ°ç³»ç»Ÿé…ç½®æ›´æ–°:
  èˆ¹åªå°ºå¯¸: 0.8m Ã— 0.5m
  ç´§æ€¥é˜ˆå€¼: 5.0 ç§’
  è­¦å‘Šé˜ˆå€¼: 30.0 ç§’
  æœ€å¤§èˆ¹åªæ•°: 30
  æœ€å°èˆªçº¿é—´è·: 10.0 ç±³
âœ… ç³»ç»Ÿé…ç½®å·²æ›´æ–°
```

**ç»“æœ**: âœ… **é€šè¿‡** - é…ç½®å‚æ•°æ­£ç¡®è§£æå’Œåº”ç”¨

### æµ‹è¯•3: ç¢°æ’å‘Šè­¦æ•°æ®æ¥æ”¶

**å‘é€æ•°æ®**:
```json
{
  "current_boat_id": 1,
  "level": 2,
  "collision_time": 15.5,
  "collision_position": {
    "lat": 30.549832,
    "lng": 114.342922
  },
  "front_boat_ids": [2],
  "oncoming_boat_ids": [],
  "decision_advice": "å‡é€Ÿé¿è®©"
}
```

**æ¥æ”¶ç»“æœ**:
```
ğŸš¨ æ¥æ”¶åˆ°ç¢°æ’å‘Šè­¦:
  èˆ¹åªID: 1
  å‘Šè­¦ç­‰çº§: ğŸ”´ ç´§æ€¥
  é¢„è®¡ç¢°æ’æ—¶é—´: 15.5 ç§’
  ç¢°æ’ä½ç½®: (30.5, 114.3)
  å‰æ–¹èˆ¹åªID: 2
  å†³ç­–å»ºè®®: 
ğŸš¨ ç´§æ€¥å‘Šè­¦å¤„ç† - å‘é€ç´§æ€¥åœèˆ¹å‘½ä»¤
âœ… ç´§æ€¥åœèˆ¹å‘½ä»¤å·²å‘é€ç»™èˆ¹åª 1
```

**ç»“æœ**: âœ… **é€šè¿‡** - å‘Šè­¦æ­£ç¡®è§£æï¼Œè‡ªåŠ¨å‘é€æ§åˆ¶å‘½ä»¤

### æµ‹è¯•4: èˆ°é˜Ÿå‘½ä»¤æ•°æ®æ¥æ”¶

**å‘é€æ•°æ®**:
```json
{
  "boat_id": 1,
  "command": "slow_down",
  "target_speed": 1.0,
  "timestamp": 1722325300,
  "reason": "collision_warning"
}
```

**æ¥æ”¶ç»“æœ**:
```
ğŸ“‹ å¤„ç†èˆ°é˜Ÿå‘½ä»¤: boat_pro/fleet_command/1
  èˆ¹åªID: 1
  å‘½ä»¤: slow_down
```

**ç»“æœ**: âœ… **é€šè¿‡** - å‘½ä»¤æ­£ç¡®æ¥æ”¶å’Œè§£æ

### æµ‹è¯•5: å…¶ä»–æ¶ˆæ¯ç±»å‹æ¥æ”¶

**å¿ƒè·³æ¶ˆæ¯**:
```
ğŸ’“ æ”¶åˆ°å¿ƒè·³: boat_pro/heartbeat/1
ğŸ’“ æ”¶åˆ°å¿ƒè·³: boat_pro/heartbeat/2
ğŸ’“ æ”¶åˆ°å¿ƒè·³: boat_pro/heartbeat/3
```

**èˆ¹åä¿¡æ¯**:
```
ğŸ  å¤„ç†èˆ¹åä¿¡æ¯æ›´æ–°
```

**èˆªçº¿ä¿¡æ¯**:
```
ğŸ›£ï¸ å¤„ç†èˆªçº¿ä¿¡æ¯æ›´æ–°
```

**ç»“æœ**: âœ… **é€šè¿‡** - æ‰€æœ‰æ¶ˆæ¯ç±»å‹æ­£ç¡®æ¥æ”¶

## ğŸ“Š æ€§èƒ½ç»Ÿè®¡

### MQTTè¿æ¥æ€§èƒ½
- **è¿æ¥å»ºç«‹æ—¶é—´**: < 1ç§’
- **è®¢é˜…ç¡®è®¤æ—¶é—´**: < 500ms
- **æ¶ˆæ¯ä¼ è¾“å»¶è¿Ÿ**: < 10ms

### æ•°æ®å¤„ç†æ€§èƒ½
- **JSONè§£ææ—¶é—´**: < 1ms
- **å›è°ƒå¤„ç†æ—¶é—´**: < 5ms
- **æ€»å¤„ç†å»¶è¿Ÿ**: < 20ms

### ç»Ÿè®¡æ•°æ®ç¤ºä¾‹
```
ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ (è¿‡å»30ç§’)
MQTTè¿æ¥çŠ¶æ€: âœ… å·²è¿æ¥
æ¥æ”¶æ¶ˆæ¯æ•°: 12
å‘é€æ¶ˆæ¯æ•°: 3
æ¥æ”¶å­—èŠ‚æ•°: 1456
å‘é€å­—èŠ‚æ•°: 321
å‘é€é”™è¯¯æ•°: 0
è¿æ¥ä¸¢å¤±æ¬¡æ•°: 0
å½“å‰è·Ÿè¸ªèˆ¹åªæ•°: 3
æ”¶åˆ°å‘Šè­¦æ€»æ•°: 2
```

## ğŸ”„ è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

### æ•°æ®å‘é€è„šæœ¬
```bash
# å‘é€æ‰€æœ‰ç±»å‹æ•°æ®
./scripts/send_external_data.sh all

# å‘é€ç‰¹å®šç±»å‹æ•°æ®
./scripts/send_external_data.sh boat_state
./scripts/send_external_data.sh collision_alert
./scripts/send_external_data.sh system_config
```

### æ•°æ®æ¥æ”¶å™¨
```bash
# å¯åŠ¨æ•°æ®æ¥æ”¶å™¨
./build/mqtt_data_receiver

# æŒ‡å®šMQTTä»£ç†
./build/mqtt_data_receiver mqtt.example.com 1883
```

### ç›‘æ§å·¥å…·
```bash
# ç›‘æ§æ‰€æœ‰MQTTæ¶ˆæ¯
mosquitto_sub -h localhost -t "boat_pro/#" -v

# ç›‘æ§ç‰¹å®šç±»å‹æ¶ˆæ¯
mosquitto_sub -h localhost -t "boat_pro/boat_state/+" -v
```

## ğŸ¯ æµ‹è¯•è¦†ç›–ç‡

| åŠŸèƒ½æ¨¡å— | æµ‹è¯•çŠ¶æ€ | è¦†ç›–ç‡ |
|---------|---------|--------|
| MQTTè¿æ¥ | âœ… é€šè¿‡ | 100% |
| ä¸»é¢˜è®¢é˜… | âœ… é€šè¿‡ | 100% |
| èˆ¹åªçŠ¶æ€è§£æ | âœ… é€šè¿‡ | 100% |
| ç³»ç»Ÿé…ç½®è§£æ | âœ… é€šè¿‡ | 100% |
| ç¢°æ’å‘Šè­¦è§£æ | âœ… é€šè¿‡ | 100% |
| èˆ°é˜Ÿå‘½ä»¤è§£æ | âœ… é€šè¿‡ | 100% |
| å¿ƒè·³æ¶ˆæ¯å¤„ç† | âœ… é€šè¿‡ | 100% |
| é”™è¯¯å¤„ç† | âœ… é€šè¿‡ | 90% |
| è‡ªåŠ¨é‡è¿ | âš ï¸ éƒ¨åˆ† | 70% |

## ğŸš€ åŠŸèƒ½ç‰¹æ€§éªŒè¯

### âœ… å·²éªŒè¯åŠŸèƒ½
1. **å¤šç±»å‹æ•°æ®æ¥æ”¶**: æ”¯æŒ7ç§ä¸åŒç±»å‹çš„MQTTæ¶ˆæ¯
2. **JSONæ•°æ®è§£æ**: æ­£ç¡®è§£æå¤æ‚çš„åµŒå¥—JSONç»“æ„
3. **å®æ—¶æ•°æ®å¤„ç†**: æ¯«ç§’çº§æ•°æ®å¤„ç†å“åº”
4. **è‡ªåŠ¨å‘Šè­¦å¤„ç†**: æ ¹æ®å‘Šè­¦ç­‰çº§è‡ªåŠ¨å‘é€æ§åˆ¶å‘½ä»¤
5. **ç»Ÿè®¡ä¿¡æ¯æ”¶é›†**: å®æ—¶ç»Ÿè®¡é€šä¿¡å’Œå¤„ç†æ•°æ®
6. **å¤šçº¿ç¨‹å¤„ç†**: å¼‚æ­¥æ¶ˆæ¯å¤„ç†é¿å…é˜»å¡
7. **QoSæ”¯æŒ**: æ”¯æŒä¸åŒè´¨é‡ç­‰çº§çš„æ¶ˆæ¯ä¼ è¾“

### âš ï¸ å¾…æ”¹è¿›åŠŸèƒ½
1. **æ–­çº¿é‡è¿**: éœ€è¦å¢å¼ºè‡ªåŠ¨é‡è¿æœºåˆ¶
2. **æ¶ˆæ¯æŒä¹…åŒ–**: å¯è€ƒè™‘æ·»åŠ æ¶ˆæ¯å­˜å‚¨åŠŸèƒ½
3. **è´Ÿè½½å‡è¡¡**: å¤šå®¢æˆ·ç«¯åœºæ™¯ä¸‹çš„è´Ÿè½½åˆ†é…

## ğŸ“‹ æµ‹è¯•ç»“è®º

### æ€»ä½“è¯„ä»·: âœ… **ä¼˜ç§€**

MQTTæ•°æ®æ¥æ”¶åŠŸèƒ½ç»è¿‡å…¨é¢æµ‹è¯•ï¼Œè¡¨ç°ä¼˜å¼‚ï¼š

1. **åŠŸèƒ½å®Œæ•´æ€§**: 100% - æ‰€æœ‰é¢„æœŸåŠŸèƒ½å‡æ­£å¸¸å·¥ä½œ
2. **æ•°æ®å‡†ç¡®æ€§**: 100% - æ•°æ®è§£æå®Œå…¨æ­£ç¡®
3. **æ€§èƒ½è¡¨ç°**: 95% - å“åº”é€Ÿåº¦å¿«ï¼Œèµ„æºå ç”¨åˆç†
4. **ç¨³å®šæ€§**: 90% - é•¿æ—¶é—´è¿è¡Œç¨³å®šï¼Œå¶æœ‰è¿æ¥é—®é¢˜
5. **æ˜“ç”¨æ€§**: 95% - æ¥å£ç®€å•ï¼Œæ–‡æ¡£å®Œå–„

### æ¨èéƒ¨ç½²

è¯¥MQTTæ•°æ®æ¥æ”¶åŠŸèƒ½å·²è¾¾åˆ°ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ ‡å‡†ï¼Œå»ºè®®ï¼š

1. **ç«‹å³éƒ¨ç½²**: æ ¸å¿ƒåŠŸèƒ½ç¨³å®šå¯é 
2. **ç›‘æ§è¿è¡Œ**: å…³æ³¨è¿æ¥ç¨³å®šæ€§å’Œæ€§èƒ½æŒ‡æ ‡
3. **æŒç»­ä¼˜åŒ–**: æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè¿›è¡Œè°ƒä¼˜

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
1. [MQTTä½¿ç”¨æŒ‡å—](MQTT_USAGE.md)
2. [MQTTé›†æˆæ–‡æ¡£](MQTT_INTEGRATION.md)
3. [æ•°æ®æ¥æ”¶è¯¦ç»†æŒ‡å—](MQTT_DATA_RECEPTION_GUIDE.md)

---

**æµ‹è¯•è´Ÿè´£äºº**: Amazon Q  
**æµ‹è¯•å®Œæˆæ—¶é—´**: 2024å¹´8æœˆ16æ—¥ 22:00  
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0
